Проверка продажных кодов в почте
PageSize=0;
ВЕРСИЯ=3

//ВЫПОЛНИТЬ ПРОГРАММА={EMAIL}ACTION\IMP_CTL2.PRG MAIL.FROM=FROM_KASSA КЛАСС_ДОКУМЕНТОВ=РТ ACPT_REG=-1|0|1 УДАЛЯТЬ_СЕАНС=Y УДАЛЯТЬ_ФАЙЛ=Y

//Требования:
// -для работы отчета необходимо наличие следующих дирректорий:
//  w:\mail\from_kas\ - каталог для выгрузки с касс
//  w:\mail\archive\  - каталог для хранения копий принятых кассовых лент.
//  w:\mail\now_ctl\  - каталог, в который перемещаются кассовые отчеты из
//  каталога w:\mail\from_kas для обработки программой ДОМИНО. Успешно
//  принятые отчеты удаляются из w:\mail\now_ctl, не принятые-не удаляются;
//  Отчеты с ошибками остаются в w:\mail\now_ctl и принимаются при следующем
//  запуске процедуры (прежде чем запускать повторный прием почты, необходимо
//  исправить ошибки в кассовых отчетах).
//  c:\domino\mail\   - каталог, из которого непосредственно принимаются
//  кассовые отчеты и удаляются после принятия, независимо от результата.
// -в кассовых отчетах должен быть установлен параметр ТИП, который может
//  принимать значения: ТЕКУЩАЯ, ИТОГОВАЯ. Параметр ТИП вносится в шапки
//  шаблонов выгрузки: в dwncsw.prt, dwncswp.prt ТИП=ИТОГОВАЯ,
//  а в iosw.prt ТИП=ТЕКУЩАЯ.
//     Если параметр ТИП отсутствует, то данная смена (кассовый отчет)
//  считается ИТОГОВОЙ!!!
//
//Описание отчета:
//Позволяет принимать как текущие, так и закрытые (итоговые) смены, выполняет
//следующие действия:
//-Делает резервное копирование содержимого директории w:\mail\from_kas\.
//-Проверяет наличие в ДОМИНО продажных кодов, присутствующих в отчетах, а
//также наличие партионных карточек у проданных товаров. Выводит сообщения
//в случае обнаружения ошибок на экран и пропускает отчеты с ошибками.
//-При приеме текущих отчетов создает документ, не удаляя существующие с
//такими же номерами.
//-При приеме итоговых отчетов удаляет существующие документы с такими же
// номерами и создает новый (общий) документ .


String  Cтрока_Имя;

String  Имя_Файла,
        Номер_Смены,
        Дата_Смены,
        Номер_Чека,
        Продажный_Код,
        Тип_Сообщения,
        q;

Integer Counter,
        i,
        Позиция,
        ОшибкаВТекущемФайле,
        FlagComplete,
        КоличПопыток=20,
        КолЦен,
        Счетчик;

Number (15,2) Цена_Товара;

Table Отсутствующие_Коды Unique
(Отсутствующие_Коды.Код
   Fields +Продажный_Код,
           Товар.Код
   (Отсутствующие_Коды.Файл
      Fields  Имя_Файла,
              Цена_Товара,
              Номер_Смены,
              Дата_Смены
   )
Отсутствующие_Коды.КодИтого);

Table Список_Файлов unique
  (Список_Файлов.Файл
     Fields +Имя_Файла,
             Тип_Сообщения,
             Номер_Смены,
             Дата_Смены
  );

Table СписокДокументов
  (СписокДокументов.Номер
     Fields  СКЛАД.КОД,
             ДОКУМЕНТ.ТИП,
             ДОКУМЕНТ.НОМЕР
  );



CopyFiles('w:\mail\from_kas\*.CL','w:\mail\now_ctl\');

//CommandLine ('RUN ''deltree /Y w:\mail\from_kas\*.CL');
DeleteFiles('w:\mail\from_kas\*.CL');

//Сохранение кассовых лент в архив
//CommandLine ('RUN ''copy w:\mail\NOW_CTL\*.CL w:\mail\archive\*.CL');
CopyFiles('w:\mail\NOW_CTL\*.CL','w:\mail\archive\',,1);

CommandLine ('ВЫПОЛНИТЬ ПРОГРАММА={EMAIL}ACTION\IMP_CTL4.PRG MAIL.FROM=NOW_CTL КЛАСС_ДОКУМЕНТОВ=РТ ACPT_REG_TOTAL=0 ACPT_REG_NOW=1');



//CommandLine ('RUN ''copy w:\mail\from_kas\*.CL w:\mail\now_ctl\*.CL');
//CommandLine ('RUN ''deltree /Y w:\mail\from_kas\*.CL');

//Сохранение кассовых лент в архив
//CommandLine ('RUN ''copy w:\mail\NOW_CTL\*.CL w:\mail\archive\*.CL');
//CommandLine ('ВЫПОЛНИТЬ ПРОГРАММА={EMAIL}ACTION\IMP_CTL4.PRG MAIL.FROM=NOW_CTL КЛАСС_ДОКУМЕНТОВ=РТ ACPT_REG_TOTAL=0 ACPT_REG_NOW=1');
//│
//┘